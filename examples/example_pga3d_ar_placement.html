<HEAD>
  <META name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <SCRIPT SRC="../ganja.js"></SCRIPT>
  <STYLE>
    body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px 15px;
      border-radius: 4px;
      font-size: 14px;
      z-index: 1001;
      max-width: 300px;
    }
  </STYLE>
</HEAD>
<BODY>
<DIV id="info">
  <strong>Augmented Reality Object Placement</strong><br>
  Point your device at a surface and tap "Enter AR" to place geometric objects in the real world.
  <br><br>
  <small>Requires a WebXR-compatible browser and AR-capable device.</small>
</DIV>
<SCRIPT>
// Create a Clifford Algebra with 3,0,1 metric for 3D PGA
Algebra(3,0,1,()=>{
  
  // Define basic geometric primitives in PGA
  var point = (x,y,z)=>!(1e0 + x*1e1 + y*1e2 + z*1e3);
  var line = (...plucker)=>plucker*[1e01,1e02,1e03,1e12,1e13,1e23];
  
  // AR placement state
  var placedObjects = [];
  var hitPoseMatrix = null;
  
  // Function to create a geometric object (cube made of lines)
  var createCube = (center, size) => {
    var s = size * 0.5;
    var points = [
      point(center[0]-s, center[1]-s, center[2]-s),  // 0
      point(center[0]+s, center[1]-s, center[2]-s),  // 1
      point(center[0]+s, center[1]+s, center[2]-s),  // 2
      point(center[0]-s, center[1]+s, center[2]-s),  // 3
      point(center[0]-s, center[1]-s, center[2]+s),  // 4
      point(center[0]+s, center[1]-s, center[2]+s),  // 5
      point(center[0]+s, center[1]+s, center[2]+s),  // 6
      point(center[0]-s, center[1]+s, center[2]+s),  // 7
    ];
    
    return [
      // Bottom face
      [points[0], points[1]], [points[1], points[2]], [points[2], points[3]], [points[3], points[0]],
      // Top face
      [points[4], points[5]], [points[5], points[6]], [points[6], points[7]], [points[7], points[4]],
      // Vertical edges
      [points[0], points[4]], [points[1], points[5]], [points[2], points[6]], [points[3], points[7]]
    ];
  };
  
  // Hit test callback for AR placement
  var onHitTest = (hitPose, sceneData) => {
    // Store the hit pose matrix for potential object placement
    hitPoseMatrix = hitPose.transform.matrix;
    
    // You could automatically place objects here
    // or wait for user interaction (tap/click)
  };
  
  // Scene generation function
  var generateScene = () => {
    var objects = [];
    
    // Add a color
    objects.push(0x00AA88);
    
    // Add placed objects
    placedObjects.forEach((obj) => {
      objects.push(0xFF8844);
      obj.edges.forEach(edge => objects.push(edge));
    });
    
    // Add a preview cube at the hit test location if available
    if (hitPoseMatrix) {
      var x = hitPoseMatrix[12];
      var y = hitPoseMatrix[13];
      var z = hitPoseMatrix[14];
      
      objects.push(0x4488FF);
      var previewCube = createCube([x, y + 0.1, z], 0.2);
      previewCube.forEach(edge => objects.push(edge));
    }
    
    // Add instructions
    objects.push(0x224488);
    objects.push("Tap surface to place objects");
    
    return objects;
  };
  
  // Check if WebXR is available
  if (!navigator.xr) {
    document.getElementById('info').innerHTML = 
      '<strong>WebXR Not Supported</strong><br>' +
      'Your browser does not support WebXR. Please use a compatible browser like Chrome on Android.';
    
    // Fallback: Show regular 3D scene
    document.body.appendChild(this.graph(()=>{
      var A = point(0, 0.5, 0);
      var B = point(0.5, -0.5, -0.5);
      var C = point(-0.5, -0.5, -0.5);
      var D = point(0.5, -0.5, 0.5);
      var E = point(-0.5, -0.5, 0.5);
      
      return [
        "WebXR not available - showing 3D preview",
        0xD0FFE1, [A,B,D],
        0x00AA88, [A,B],[A,C],[A,D],[A,E],[B,C],[C,E],[E,D],[D,B],
        0x224488, A,"A",B,"B",C,"C",D,"D",E,"E"
      ];
    }, {
      grid: true,
      labels: true,
      lineWidth: 3,
      pointRadius: 1,
      fontSize: 1,
      scale: 1,
    }));
  } else {
    // Use WebXR AR mode
    document.body.appendChild(this.graphXR(generateScene, {
      xr: 'ar',
      onHitTest: onHitTest,
      lineWidth: 3,
      pointRadius: 1.5,
    }));
    
    // Add tap listener to place objects
    document.addEventListener('click', () => {
      if (hitPoseMatrix && placedObjects.length < 10) {
        var x = hitPoseMatrix[12];
        var y = hitPoseMatrix[13];
        var z = hitPoseMatrix[14];
        
        placedObjects.push({
          position: [x, y, z],
          edges: createCube([x, y + 0.1, z], 0.2)
        });
        
        console.log('Placed object at', x, y, z);
      }
    });
  }
});
</SCRIPT>
</BODY>
